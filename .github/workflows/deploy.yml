name: Deploy Application

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed

jobs:
  deploy:
    name: Deploy to Environment
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server (SSH Example)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Create SSH key file
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Deploy commands (customize based on your setup)
          ssh -T -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << EOF
              echo "Pulling new Docker image..."
              docker compose pull whitelist
              
              echo "Stopping existing container..."
              docker compose down whitelist || true
              
              echo "Starting new container..."
              docker compose up -d whitelist || true
              
              echo "Cleaning up old images..."
              docker image prune -af
          EOF
